---
title: "Laboration 2"
output:
  html_document:
    keep_md: true
---
# Laboration 2

 #### Deadline
  - Laboration: 02/07/2023
  - Kamratgranskning: 05/07/2023


Laborationen består av två uppgifter med ett antal delfrågor och kamratgranskning. Lösningen skall presenteras i form av en källkodsfil `laboration2.Rmd` skriven i R Markdown med `output: github_document` tillsammans med en kompilerad version `laboration2.md` och tillhörande bilder/figurer. Använd ett kodblock ("R chunk") per delfråga och fyll på med så mycket beskrivande text mellan kodblocken så att det går att följa vad som görs. Att skriva lättläst kod är en konst, men en god början är att följa en konsekvent stil som i [The tidyverse style guide](https://style.tidyverse.org/). Ta dig lite tid att läsa igenom delar som verkar relevanta, att följa reglerna i [2.2](https://style.tidyverse.org/syntax.html#spacing) är en bra början.

Arbetet skall utföras individuellt och samarbete, speciellt kopiering/delning av kurskamraters kod, är inte tillåtet. Det är inte heller tillåtet att ställa direkta frågor relaterade till problemen på forum som t.ex. [Stack Overflow](https://stackoverflow.com/). Samtidigt uppmuntras ni att söka efter inspiration till lösningar baserat på redan ställda frågor på dylika forum. Tänk dock på att alltid redovisa källan.

Underlaget till laborationen finns tillgängligt på [https://github.com/MT3003-ST23](https://github.com/MT3003-ST23) som `lab2_xxx` där `xxx` är ditt användarnamn på GitHub. Hämta detta som ett projekt i RStudio Cloud på samma sätt som Laboration 1.

Till laborationen hör uppgifter markerade med **Bonus**. Dessa är frivilliga men genererar extra poäng. En bonuspoäng kommer denna gång även delas ut för den som i sin kod visar att hen tagit del av ovan nämnda stilguide.

# Fågelspaning i kungliga nationalstadsparken

På [Artportalen](https://www.artportalen.se/) kan du rapportera fynd eller observationer av djur, växter och svampar. Det är ett exempel på så kallad medborgarforskning, "citizen science", där allmänheten, forskare och tjänstemän samarbetar med att bygga upp en databas som kan användas i forskning. Till denna laboration har vi hämtat alla fågelobservationer gjorda 2022 i [kungliga nationalstadsparken](https://www.nationalstadsparken.se/), där du även hittar Stockholms universitets campus. 


```r
library(tidyverse)
read_csv("artportalen.csv") %>% 
  glimpse()
```

```r
## Rows: 21,916
## Columns: 27
## $ Id                     <dbl> 97785066, 97785067, 97785310, 97786982, 9778698…
## $ Taxonsorteringsordning <dbl> 55235, 54989, 55235, 54735, 54944, 55232, 53958…
## $ Rödlistade             <chr> NA, NA, NA, NA, NA, "NT", NA, NA, NA, NA, NA, N…
## $ Artnamn                <chr> "Koltrast", "Blåmes", "Koltrast", "Sparvhök", "…
## $ `Vetenskapligt namn`   <chr> "Turdus merula", "Cyanistes caeruleus", "Turdus…
## $ Auktor                 <chr> "Linnaeus, 1758", "(Linnaeus, 1758)", "Linnaeus…
## $ Antal                  <chr> "2", "2", "1", "1", "2", "10", "1", "5", "5", "…
## $ `Ålder/stadium`        <chr> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,…
## $ Kön                    <chr> NA, NA, NA, "hona", NA, NA, NA, NA, NA, NA, NA,…
## $ Aktivitet              <chr> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,…
## $ Lokalnamn              <chr> "Björnstigen 129,Bergshamra,Solna", "Björnstige…
## $ Ostkoordinat           <dbl> 1626890, 1626890, 1626094, 1626094, 1626780, 16…
## $ Nordkoordinat          <dbl> 6586736, 6586736, 6585523, 6585523, 6585860, 65…
## $ Noggrannhet            <dbl> 25, 25, 100, 100, 125, 100, 1344, 1344, 1344, 1…
## $ Diffusion              <dbl> 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,…
## $ Län                    <chr> "Stockholm", "Stockholm", "Stockholm", "Stockho…
## $ Kommun                 <chr> "Solna", "Solna", "Solna", "Solna", "Solna", "S…
## $ Provins                <chr> "Uppland", "Uppland", "Uppland", "Uppland", "Up…
## $ Församling             <chr> "Solna", "Solna", "Solna", "Solna", "Solna", "S…
## $ Startdatum             <date> 2022-01-01, 2022-01-01, 2022-01-01, 2022-01-01…
## $ Starttid               <time>       NA,       NA,       NA,       NA, 15:57:…
## $ Slutdatum              <date> 2022-01-01, 2022-01-01, 2022-01-01, 2022-01-01…
## $ Sluttid                <time>       NA,       NA,       NA,       NA, 09:36:…
## $ Kommentar              <chr> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,…
## $ Biotop                 <lgl> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,…
## $ Rapportör              <chr> "Björn Lindkvist", "Björn Lindkvist", "Anders E…
## $ Observatörer           <chr> "Björn Lindkvist", "Björn Lindkvist", "Anders E…
```

Några observartioner:

- Vi får ett varningsmeddelande om "parsing issues".
- Kolumnen `Antal` har blivit läst som text (`chr`) trots att den förefaller vara numerisk.
- En del kolumnnamn är opraktiska då de innehåller mellanslag och/eller speciella tecken. Även svenska åäö bör undvikas i namn på funktioner och variabler då de kan orsaka problem på datorer med andra nationella inställningar.
- Flera variabler innehåller saknade värden markerade med `NA`.

Kolumnernas format (numerisk, text, datum, ...) gissas av funktionen `read_csv` baserat på de första 1000 värdena. Om samtliga dessa saknas (är `NA`) antas kolumnen vara logisk (`TRUE/FALSE`) och översätts till detta format. I kolumnen `Biotop` finns dock ett ensamt värde "Stadsmiljö" på rad 14133, och detta kan 
inte `read_csv` översätta till logiskt format. Därför vi får en varning om "parsing issues". Vid översättning till logiskt variabelformat går detta värde förlorat (ändras till `NA`). För att undvika problemet kan vi ange argumentet `guess_max = 50000`, vilket instruerar `read_csv` att basera gissningen på de första 50000 raderna. På så sätt tar det något längre tid att läsa in filen, men `Biotop` blir korrekt klassad som text. När det gäller kolumnen `Antal` visar det sig att den innehåller en del rader med "noterad" eller "Ej återfunnen" och därför blivit klassad som text, vi kommer inte anväda denna kolumn och låter den därför vara. För att städa upp kolumnnamnen kan vi använda funktionen `clean_names` i paketet `janitor`. Vi läser nu åter in data med 

```r
data_artportal <- read_csv("artportalen.csv", guess_max = 50000) %>% 
  janitor::clean_names()
glimpse(data_artportal)
```

```r
## Rows: 21,916
## Columns: 27
## $ id                     <dbl> 97785066, 97785067, 97785310, 97786982, 9778698…
## $ taxonsorteringsordning <dbl> 55235, 54989, 55235, 54735, 54944, 55232, 53958…
## $ rodlistade             <chr> NA, NA, NA, NA, NA, "NT", NA, NA, NA, NA, NA, N…
## $ artnamn                <chr> "Koltrast", "Blåmes", "Koltrast", "Sparvhök", "…
## $ vetenskapligt_namn     <chr> "Turdus merula", "Cyanistes caeruleus", "Turdus…
## $ auktor                 <chr> "Linnaeus, 1758", "(Linnaeus, 1758)", "Linnaeus…
## $ antal                  <chr> "2", "2", "1", "1", "2", "10", "1", "5", "5", "…
## $ alder_stadium          <chr> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,…
## $ kon                    <chr> NA, NA, NA, "hona", NA, NA, NA, NA, NA, NA, NA,…
## $ aktivitet              <chr> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,…
## $ lokalnamn              <chr> "Björnstigen 129,Bergshamra,Solna", "Björnstige…
## $ ostkoordinat           <dbl> 1626890, 1626890, 1626094, 1626094, 1626780, 16…
## $ nordkoordinat          <dbl> 6586736, 6586736, 6585523, 6585523, 6585860, 65…
## $ noggrannhet            <dbl> 25, 25, 100, 100, 125, 100, 1344, 1344, 1344, 1…
## $ diffusion              <dbl> 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,…
## $ lan                    <chr> "Stockholm", "Stockholm", "Stockholm", "Stockho…
## $ kommun                 <chr> "Solna", "Solna", "Solna", "Solna", "Solna", "S…
## $ provins                <chr> "Uppland", "Uppland", "Uppland", "Uppland", "Up…
## $ forsamling             <chr> "Solna", "Solna", "Solna", "Solna", "Solna", "S…
## $ startdatum             <date> 2022-01-01, 2022-01-01, 2022-01-01, 2022-01-01…
## $ starttid               <time>       NA,       NA,       NA,       NA, 15:57:…
## $ slutdatum              <date> 2022-01-01, 2022-01-01, 2022-01-01, 2022-01-01…
## $ sluttid                <time>       NA,       NA,       NA,       NA, 09:36:…
## $ kommentar              <chr> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,…
## $ biotop                 <chr> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,…
## $ rapportor              <chr> "Björn Lindkvist", "Björn Lindkvist", "Anders E…
## $ observatorer           <chr> "Björn Lindkvist", "Björn Lindkvist", "Anders E…
```
och är nu nöjda.

## Uppgifter

- Skapa en tabell över 10 mest rapporterade arterna (efter `artnamn`) och antalet gånger de blivit rapporterade. Funktionerna i `slice`-familjen kan hjälpa till att begränsa listan (se `?slice`). En enkel tabell i R Markdown kan formateras med `knitr::kable`.
- Skapa en tabell över de 10 rapportörer (`rapportor`) som registrerat flest *olika* fågelarter (funktionen `n_distinct` kan vara användbar). Eftersom det inte finns något unikt rapportör-id får du anta att namnen är unika. 
- Välj ut de 12 mest rapporterade arterna och illustrera antalet observationer per art och kalendervecka med stapeldiagram. Du kan få veckonummer med `lubridate::isoweek(startdatum)`och skall använda `facet_wrap` för att dela upp efter art. Ett potentiellt problem är att första dagarna i januari tillhör vecka 53, här kan du t.ex. använda `forcats::fct_relevel` för att placera motsvarande stapel först. Se exempel i `?forcats::fct_relevel`. Vilka arter verkar vara flyttfåglar? Du kan kontrollera på naturhistoriska riksmuseets [lista över våra vanligaste flyttfåglar](https://www.nrm.se/faktaomnaturenochrymden/djur/faglar/vanligafaglar/vanligavarfaglarao.5780.html).
- **Bonus:** I ovanstående uppgift illustrerar du istället den veckovisa *andelen* av alla observationer som tillhör den valda arten.
- **Bonus:** I kolumnen `aktivitet` står ibland noterat under vilka omständigheter fågeln observerats. Skapa en ny variabel som antar värdet `"Parning"` om textsträngen `aktivitet` innehåller ordet `"parning"`, värdet `"Ungar"` om den innehåller ordet `"ungar"` och annars `NA`. Illustrera sedan `startdatum` för parning och ungar med `geom_density` färglagt (`color`) efter den nya variabeln (filtrera bort de som fått värde `NA`). Variabeln skapar du t.ex. med `case_when` i kombination med `str_detect`.
- Sädesärlan är ett populärt vårtecken. I `artportalen_arla.csv` har vi valt ut alla observationer av Sädesärlor i nationalstadsparken sedan år 2000, filen är för övrigt i samma format som `artportalen.csv`. Illustrera hur första observationsdag varierat med åren med ett punktdiagram och en anpassad rät linje (`geom_smooth` med argumentet `method = "lm"` ger en sådan). Dag på året fås med `lubridate::yday(startdatum)`. Att flyttfåglars ankomst tidigareläggs  ses ibland som en effekt av global uppvärmning, kan du tänka dig en alternativ förklaring i detta fall?

<div class="figure" style="text-align: center">
<img src="https://upload.wikimedia.org/wikipedia/commons/5/55/White-Wagtail.jpg" alt="Sädesärla. Bildkälla: Andreas Trepte, Wikimedia Commons"  />
<p class="caption">Sädesärla. Bildkälla: Andreas Trepte, Wikimedia Commons</p>
</div>


# Massvaccinering

Excelarket `Folkhalsomyndigheten_Covid19_Vaccine.xlsx` innehåller statistik över covid-19 vaccinerade från 10/6 2022 hämtad från [folkhälsomyndighetens statistiksida](https://www.folkhalsomyndigheten.se/smittskydd-beredskap/utbrott/aktuella-utbrott/covid-19/statistik-och-analyser/statistik-over-registrerade-vaccinationer-covid-19/). Tabeller finns sparade i olika flikar, du kan lista flikarna med

```r
readxl::excel_sheets("Folkhalsomyndigheten_Covid19_Vaccine.xlsx")
```

```r
##  [1] "Vaccinationer tidsserie"      "Vaccinerade tidsserie"       
##  [3] "Vaccinerade tidsserie dos 3"  "Vaccinerade tidsserie dos 4" 
##  [5] "Vaccinerade ålder"            "Dos 3 per åldersgrupp"       
##  [7] "Dos 4 per åldersgrupp"        "Vaccinerade kön"             
##  [9] "Vaccinerade kommun"           "Vaccinerade kommun dos 3"    
## [11] "Vaccinerade kommun dos 4"     "Vaccinerade kommun och ålder"
## [13] "FOHM 02 JUN 2022"
```


## Uppgifter

- Nedanstående figur kommer från sidan med FHMs interaktiva grafik och visar andel vaccinerade med tre doser i hela landet uppdelat efter åldersgrupp. Gör motsvarande figur för valfri region, du behöver inte efterlikna färgsättning och andra grafiska element. Data hittar du i fliken `Vaccinerade ålder` som läses in med

```r
vacc_alder <- readxl::read_excel("Folkhalsomyndigheten_Covid19_Vaccine.xlsx", 
                                 sheet = "Dos 3 per åldersgrupp") # Typo fixed 22-06-10
```
**Tips:** För att få `y`-axeln uttryckt i procent kan du lägga till `+ scale_y_continuous(labels = scales::label_percent())` till ditt `ggplot`-anrop. 

<img src="/img/fhmfig.png" style="display: block; margin: auto;" />

-  Nedanstående figur illustrerar hur vaccinationsframgången varierar mellan kommuner i Skåne, Stockholms och Västra Götalands län baserat på data i fliken `Vaccinerade kommun och ålder` (fliken `Vaccinerade kommun` innehåller inte all nödvändig information). Gör motsvarande figur. Vill du undvika den tekniska notationen 2e+05 i teckenförklaringen för Befolkning lägger du till `+ scale_size_continuous(labels = scales::label_number())`.

<img src="/img/unnamed-chunk-7-1.png" style="display: block; margin: auto;" />

- **Bonus:** Gör en figur som illustrerar antalet vaccinationer utförda per vecka och region under baserat på data i fliken `Vaccinationer tidsserie`, t.ex. genom att dela upp regionerna med `facet_wrap`.  Notera att kolumnen `Antal vaccinationer` visar det kumulativa antalet och inte antalet vaccinationer den aktuella veckan. Prova lägga till argumentet `scales = "free_y"` till `facet_wrap`. Ett veckonummer som löper över hela perioden kan du skapa med `Vecka - 51 + (År - 2020) * 53`.

# Kamratgranskning

När du fått tillgång till en kamrats inlämning:

- Hämta den som ett nytt projekt till RStudio Cloud.
- Öppna `laboration2.Rmd` och kontrollera att den kompilerar (Knit) utan problem.
- Läs igenom laborationen och reflektera över skillnader/likheter med dina egna lösningar.
- I ett svar till kamratens issue, rapportera "Provkört utan problem!" om så är fallet, annars rapporterar du eventuella problem. Ge även feedback baserat på dina reflektioner ovan, håll god ton.


